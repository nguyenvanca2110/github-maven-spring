=================== Azure ========================
# Login to Azure

az login

export RESOURCE_GROUP='gradle-demo'
export AKS_CLUSTER='gradle-canv'
export ACR_NAME='gradlecanvacr'
export ACR_URL='gradlecanvacr.azurecr.io'

echo $AKS_NAMESPACE

echo $RESOURCE_GROUP
echo $AKS_CLUSTER
echo $ACR_NAME
echo $ACR_URL
=================== Azure AKS ========================
# Create Azure AKS cluster 

az aks create -n $AKS_CLUSTER -g $RESOURCE_GROUP --generate-ssh-keys --attach-acr $ACR_NAME
# Attach using acr-name
az aks update -n $AKS_CLUSTER -g $RESOURCE_GROUP --attach-acr $ACR_NAME

# Attach using acr-resource-id
az aks update -n $AKS_CLUSTER -g $RESOURCE_GROUP --attach-acr <acr-resource-id>

#  Get the credentials of AKS in local to mange the AKS Cluster 
az aks get-credentials --resource-group=<RGNAME> --name=<AKSCLUSTERNAME>

az aks get-credentials --resource-group=$RESOURCE_GROUP --name=$AKS_CLUSTER --overwrite-existing

#  Get all AKS namespace 
kubectl get all --all-namespaces -o wide

#  Creat a new namespace
kubectl create -f ./new-namespace.yaml

# List all pods in ps output format
kubectl get pods

# List all pods in ps output format with more information (such as node name)
kubectl get pods -o wide

kubectl get nodes

# List all services using in the Cluster 
kubectl get services 

=================== Azure ACR ========================

# List repositories in a given Azure Container Registry.
# az acr repository list --name MyRegistry
az acr repository list --name $ACR_NAME

# List container registries in a resource group and show the results in a table.
az acr list --resource-group $RESOURCE_GROUP --output table

# List repositories in an Azure Container Registry. (autogenerated)
# az acr repository list --name MyRegistry --resource-group myresourcegroup
az acr repository list --name $ACR_NAME --resource-group $RESOURCE_GROUP

# For deploying Docker images from ACR into AKS clusters
# We need to make an authentication between AKS and ACR to AKS can PULL an image from ACR
az aks update --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --attach-acr $ACR_NAME

# Import the image from the registries to AKS 
az acr import –name canv-app –source mcr.microsoft.com/azuredocs/azure-vote-front:v2 –image azure-vote-front:v2

=================== DOCKER ========================
# login to ACR Registries for push image
docker login <REGISTRY_NAME>.azurecr.io -u <appId> -p <password>

docker login $ACR_URL -u $POC_ACR_CREDENTIALS_USR -p $POC_ACR_CREDENTIALS_PSW

# Push image to ACR:
docker push $ACR_URL/nodeapp_app:$BUILD_NUMBER

================================================
# Store credential for AKS, the secret 'lsepocnodejs-secret' will be used to pull the image
# Because we can have multiple Registries
 
kubectl create secret docker-registry <secret-name> --namespace <namespace> --docker-server=<REGISTRY_NAME>.azurecr.io --docker-username=<appId> --docker-password=<password>
 
kubectl create secret docker-registry lsepocnodejs-secret --namespace canv-aks-demo9138 --docker-server canvnodejsapp.azurecr.io --docker-username=$POC_ACR_CREDENTIALS_USR --docker-password=$POC_ACR_CREDENTIALS_PSW

 

# ======= Deploy to AKS and Test

# make 
kubectl apply -f kube-manifests/

# deploy a service in CLuster
kubectl apply -f aks_deployment/aks-service-deployment.yml



# List Pods
kubectl get pods

# Describe Pod
kubectl describe pod <pod-name>

# Get Load Balancer IP
kubectl get svc

# Access Application
http://<External-IP-from-get-service-output>

















# =====================================================================================
 # Export Command
export ACR_REGISTRY=canvnodejsapp.azurecr.io
export ACR_NAMESPACE=canv-aks-demo9138
export ACR_IMAGE_NAME=kube-nginx-acr
export ACR_IMAGE_TAG=v1
echo $ACR_REGISTRY, $ACR_NAMESPACE, $ACR_IMAGE_NAME, $ACR_IMAGE_TAG

# Login to ACR
docker login $ACR_REGISTRY


=== Configure ACR integration for existing AKS clusters¶

#Set ACR NAME
export ACR_NAME=canv-aks-demo9138
echo $ACR_NAME

# Template
az aks update -n $AKS_CLUSTER -g $RESOURCE_GROUP --attach-acr <acr-name>

# Replace Cluster, Resource Group and ACR Repo Name
az aks update -n aksdemo2 -g aks-rg2 --attach-acr $ACR_NAME



===================== Azure AKS Credential ===========

export RESOURCE_GROUP='gradle-demo'
export AKS_CLUSTER='gradle-canv'
export ACR_NAME='gradlecanvacr'
export ACR_URL='gradlecanvacr.azurecr.io'

echo $AKS_NAMESPACE

echo $RESOURCE_GROUP
echo $AKS_CLUSTER
echo $ACR_NAME
echo $ACR_URL


1) Login to Azure 
az login 

/*
jenkins@ubuntu:~$ az login
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code HM3KBMY6C to authenticate.
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "ce07a444-1093-47fa-ad63-63e12635c01d",
    "id": "ce26c328-ebeb-4568-b91c-7d100e525c92",
    "isDefault": true,
    "managedByTenants": [],
    "name": "Azure Kakashi",
    "state": "Enabled",
    "tenantId": "ce07a444-1093-47fa-ad63-63e12635c01d",
    "user": {
      "name": "kakashibka@gmail.com",
      "type": "user"
    }
  }
]

2) Create an ACR 
jenkins@ubuntu:~$ az acr create --name $ACR_NAME --resource-group $RESOURCE_GROUP --sku Basic
{
  "adminUserEnabled": false,
  "anonymousPullEnabled": false,
  "creationDate": "2023-02-05T18:29:03.934786+00:00",
  "dataEndpointEnabled": false,
  "dataEndpointHostNames": [],
  "encryption": {
    "keyVaultProperties": null,
    "status": "disabled"
  },
  "id": "/subscriptions/ce26c328-ebeb-4568-b91c-7d100e525c92/resourceGroups/gradle-demo/providers/Microsoft.ContainerRegistry/registries/gradlecanvacr",
  "identity": null,
  "location": "koreacentral",
  "loginServer": "gradlecanvacr.azurecr.io",
  "name": "gradlecanvacr",
  "networkRuleBypassOptions": "AzureServices",
  "networkRuleSet": null,
  "policies": {
    "azureAdAuthenticationAsArmPolicy": {
      "status": "enabled"
    },
    "exportPolicy": {
      "status": "enabled"
    },
    "quarantinePolicy": {
      "status": "disabled"
    },
    "retentionPolicy": {
      "days": 7,
      "lastUpdatedTime": "2023-02-05T18:29:17.034558+00:00",
      "status": "disabled"
    },
    "softDeletePolicy": {
      "lastUpdatedTime": "2023-02-05T18:29:17.034558+00:00",
      "retentionDays": 7,
      "status": "disabled"
    },
    "trustPolicy": {
      "status": "disabled",
      "type": "Notary"
    }
  },
  "privateEndpointConnections": [],
  "provisioningState": "Succeeded",
  "publicNetworkAccess": "Enabled",
  "resourceGroup": "gradle-demo",
  "sku": {
    "name": "Basic",
    "tier": "Basic"
  },
  "status": null,
  "systemData": {
    "createdAt": "2023-02-05T18:29:03.934786+00:00",
    "createdBy": "kakashibka@gmail.com",
    "createdByType": "User",
    "lastModifiedAt": "2023-02-05T18:29:03.934786+00:00",
    "lastModifiedBy": "kakashibka@gmail.com",
    "lastModifiedByType": "User"
  },
  "tags": {},
  "type": "Microsoft.ContainerRegistry/registries",
  "zoneRedundancy": "Disabled"
} 
*/

2) Get the ACR login server:
az acr show --name $ACR_NAME --query $ACR_URL 

3) Create a service principal for AKS:
az ad sp create-for-rbac --skip-assignment
/*
jenkins@ubuntu:~$ az ad sp create-for-rbac --skip-assignment
Option '--skip-assignment' has been deprecated and will be removed in a future release.
The output includes credentials that you must protect. Be sure that you do not include these credentials in your code or check the credentials into your source control. For more information, see https://aka.ms/azadsp-cli
{
  "appId": "3a04c607-d9e6-41e2-a9dd-3a559a556d0e",
  "displayName": "azure-cli-2023-02-05-18-42-27",
  "password": "Q3a8Q~mzFbQET1lMMmpOagLeA3mOXQPP5MWaDar8",
  "tenant": "ce07a444-1093-47fa-ad63-63e12635c01d"
}
*/

4) Create an AKS cluster:
az aks create --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --node-count 1 --generate-ssh-keys --service-principal 3a04c607-d9e6-41e2-a9dd-3a559a556d0e --client-secret Q3a8Q~mzFbQET1lMMmpOagLeA3mOXQPP5MWaDar8

/*
{
  "aadProfile": null,
  "addonProfiles": null,
  "agentPoolProfiles": [
    {
      "availabilityZones": null,
      "count": 1,
      "creationData": null,
      "currentOrchestratorVersion": "1.24.9",
      "enableAutoScaling": false,
      "enableEncryptionAtHost": false,
      "enableFips": false,
      "enableNodePublicIp": false,
      "enableUltraSsd": false,
      "gpuInstanceProfile": null,
      "hostGroupId": null,
      "kubeletConfig": null,
      "kubeletDiskType": "OS",
      "linuxOsConfig": null,
      "maxCount": null,
      "maxPods": 110,
      "minCount": null,
      "mode": "System",
      "name": "nodepool1",
      "nodeImageVersion": "AKSUbuntu-1804gen2containerd-2023.01.20",
      "nodeLabels": null,
      "nodePublicIpPrefixId": null,
      "nodeTaints": null,
      "orchestratorVersion": "1.24.9",
      "osDiskSizeGb": 128,
      "osDiskType": "Managed",
      "osSku": "Ubuntu",
      "osType": "Linux",
      "podSubnetId": null,
      "powerState": {
        "code": "Running"
      },
      "provisioningState": "Succeeded",
      "proximityPlacementGroupId": null,
      "scaleDownMode": null,
      "scaleSetEvictionPolicy": null,
      "scaleSetPriority": null,
      "spotMaxPrice": null,
      "tags": null,
      "type": "VirtualMachineScaleSets",
      "upgradeSettings": {
        "maxSurge": null
      },
      "vmSize": "Standard_DS2_v2",
      "vnetSubnetId": null,
      "workloadRuntime": null
    }
  ],
  "apiServerAccessProfile": null,
  "autoScalerProfile": null,
  "autoUpgradeProfile": null,
  "azurePortalFqdn": "gradle-can-gradle-demo-ce26c3-ded65ee9.portal.hcp.koreacentral.azmk8s.io",
  "currentKubernetesVersion": "1.24.9",
  "disableLocalAccounts": false,
  "diskEncryptionSetId": null,
  "dnsPrefix": "gradle-can-gradle-demo-ce26c3",
  "enablePodSecurityPolicy": null,
  "enableRbac": true,
  "extendedLocation": null,
  "fqdn": "gradle-can-gradle-demo-ce26c3-ded65ee9.hcp.koreacentral.azmk8s.io",
  "fqdnSubdomain": null,
  "httpProxyConfig": null,
  "id": "/subscriptions/ce26c328-ebeb-4568-b91c-7d100e525c92/resourcegroups/gradle-demo/providers/Microsoft.ContainerService/managedClusters/gradle-canv",
  "identity": null,
  "identityProfile": null,
  "kubernetesVersion": "1.24.9",
  "linuxProfile": {
    "adminUsername": "azureuser",
    "ssh": {
      "publicKeys": [
        {
          "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0rDygFXrZsW1Q1ENeLkJnjzgFRG+WXtKLkKEaBp5Jc7gFYi2fsUbgJZDZ/CHQMtvtLDcimwpPw/QN/wFZq4U3+wq8hZznXpE+rmrkPTbEyhPN0JWtS3jE4OmzNt27fMJ1xDKWqj3dN9rBg7+drFv8wVyGlbfEj1rZstr+7+e3/IPcd3YhS6CamqMGOBjRHGs0xIqCzkH/FHuyjKEz9UmYNCfiCkMb1dPswmQyFYC1B34iwnaJb1W56OhCjtPHjunTy21/R940M5Ns6aO9NPoLCt4gidxkuZnHZFLIpLdnZ37nL8OQ7MrV2rR2y8PhBteQ0Djmefnn6sKnldFD/vUdXaGcaNPmTlfTURSeGSsk7i2O/+MWemac5xU1Tqxbv9yhvCs8NBUEcOL7HpqYgyQym6NhfCJ8btfuKx/XBh2NHnzxMOy10Yarn5kyiXDUXeh37gAwech6nkaxC8n/LFYWoYSaDlSAuWA3MXnoomWUgE1UVWDgdh4uqVP++NSQKQU= jenkins@ubuntu\n"
        }
      ]
    }
  },
  "location": "koreacentral",
  "maxAgentPools": 100,
  "name": "gradle-canv",
  "networkProfile": {
    "dnsServiceIp": "10.0.0.10",
    "dockerBridgeCidr": "172.17.0.1/16",
    "ipFamilies": [
      "IPv4"
    ],
    "loadBalancerProfile": {
      "allocatedOutboundPorts": null,
      "effectiveOutboundIPs": [
        {
          "id": "/subscriptions/ce26c328-ebeb-4568-b91c-7d100e525c92/resourceGroups/MC_gradle-demo_gradle-canv_koreacentral/providers/Microsoft.Network/publicIPAddresses/3ae5a339-c76c-4eba-8d64-227c08272f7f",
          "resourceGroup": "MC_gradle-demo_gradle-canv_koreacentral"
        }
      ],
      "enableMultipleStandardLoadBalancers": null,
      "idleTimeoutInMinutes": null,
      "managedOutboundIPs": {
        "count": 1,
        "countIpv6": null
      },
      "outboundIPs": null,
      "outboundIpPrefixes": null
    },
    "loadBalancerSku": "Standard",
    "natGatewayProfile": null,
    "networkMode": null,
    "networkPlugin": "kubenet",
    "networkPolicy": null,
    "outboundType": "loadBalancer",
    "podCidr": "10.244.0.0/16",
    "podCidrs": [
      "10.244.0.0/16"
    ],
    "serviceCidr": "10.0.0.0/16",
    "serviceCidrs": [
      "10.0.0.0/16"
    ]
  },
  "nodeResourceGroup": "MC_gradle-demo_gradle-canv_koreacentral",
  "oidcIssuerProfile": {
    "enabled": false,
    "issuerUrl": null
  },
  "podIdentityProfile": null,
  "powerState": {
    "code": "Running"
  },
  "privateFqdn": null,
  "privateLinkResources": null,
  "provisioningState": "Succeeded",
  "publicNetworkAccess": null,
  "resourceGroup": "gradle-demo",
  "securityProfile": {
    "azureKeyVaultKms": null,
    "defender": null
  },
  "servicePrincipalProfile": {
    "clientId": "3a04c607-d9e6-41e2-a9dd-3a559a556d0e",
    "secret": null
  },
  "sku": {
    "name": "Basic",
    "tier": "Free"
  },
  "storageProfile": {
    "blobCsiDriver": null,
    "diskCsiDriver": {
      "enabled": true
    },
    "fileCsiDriver": {
      "enabled": true
    },
    "snapshotController": {
      "enabled": true
    }
  },
  "systemData": null,
  "tags": null,
  "type": "Microsoft.ContainerService/ManagedClusters",
  "windowsProfile": null,
  "workloadAutoScalerProfile": {
    "keda": null
  }
}
*/

4) Attach the ACR instance to the AKS cluster:
az aks update --name $AKS_CLUSTER --resource-group $RESOURCE_GROUP --attach-acr $ACR_NAME

/*
jenkins@ubuntu:~$ 
jenkins@ubuntu:~$ az aks update --name $AKS_CLUSTER --resource-group $RESOURCE_GROUP --attach-acr $ACR_NAME
{
  "aadProfile": null,
  "addonProfiles": null,
  "agentPoolProfiles": [
    {
      "availabilityZones": null,
      "count": 1,
      "creationData": null,
      "currentOrchestratorVersion": "1.24.9",
      "enableAutoScaling": false,
      "enableEncryptionAtHost": false,
      "enableFips": false,
      "enableNodePublicIp": false,
      "enableUltraSsd": false,
      "gpuInstanceProfile": null,
      "hostGroupId": null,
      "kubeletConfig": null,
      "kubeletDiskType": "OS",
      "linuxOsConfig": null,
      "maxCount": null,
      "maxPods": 110,
      "minCount": null,
      "mode": "System",
      "name": "nodepool1",
      "nodeImageVersion": "AKSUbuntu-1804gen2containerd-2023.01.20",
      "nodeLabels": null,
      "nodePublicIpPrefixId": null,
      "nodeTaints": null,
      "orchestratorVersion": "1.24.9",
      "osDiskSizeGb": 128,
      "osDiskType": "Managed",
      "osSku": "Ubuntu",
      "osType": "Linux",
      "podSubnetId": null,
      "powerState": {
        "code": "Running"
      },
      "provisioningState": "Succeeded",
      "proximityPlacementGroupId": null,
      "scaleDownMode": null,
      "scaleSetEvictionPolicy": null,
      "scaleSetPriority": null,
      "spotMaxPrice": null,
      "tags": null,
      "type": "VirtualMachineScaleSets",
      "upgradeSettings": {
        "maxSurge": null
      },
      "vmSize": "Standard_DS2_v2",
      "vnetSubnetId": null,
      "workloadRuntime": null
    }
  ],
  "apiServerAccessProfile": null,
  "autoScalerProfile": null,
  "autoUpgradeProfile": null,
  "azurePortalFqdn": "gradle-can-gradle-demo-ce26c3-ded65ee9.portal.hcp.koreacentral.azmk8s.io",
  "currentKubernetesVersion": "1.24.9",
  "disableLocalAccounts": false,
  "diskEncryptionSetId": null,
  "dnsPrefix": "gradle-can-gradle-demo-ce26c3",
  "enablePodSecurityPolicy": null,
  "enableRbac": true,
  "extendedLocation": null,
  "fqdn": "gradle-can-gradle-demo-ce26c3-ded65ee9.hcp.koreacentral.azmk8s.io",
  "fqdnSubdomain": null,
  "httpProxyConfig": null,
  "id": "/subscriptions/ce26c328-ebeb-4568-b91c-7d100e525c92/resourcegroups/gradle-demo/providers/Microsoft.ContainerService/managedClusters/gradle-canv",
  "identity": null,
  "identityProfile": null,
  "kubernetesVersion": "1.24.9",
  "linuxProfile": {
    "adminUsername": "azureuser",
    "ssh": {
      "publicKeys": [
        {
          "keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0rDygFXrZsW1Q1ENeLkJnjzgFRG+WXtKLkKEaBp5Jc7gFYi2fsUbgJZDZ/CHQMtvtLDcimwpPw/QN/wFZq4U3+wq8hZznXpE+rmrkPTbEyhPN0JWtS3jE4OmzNt27fMJ1xDKWqj3dN9rBg7+drFv8wVyGlbfEj1rZstr+7+e3/IPcd3YhS6CamqMGOBjRHGs0xIqCzkH/FHuyjKEz9UmYNCfiCkMb1dPswmQyFYC1B34iwnaJb1W56OhCjtPHjunTy21/R940M5Ns6aO9NPoLCt4gidxkuZnHZFLIpLdnZ37nL8OQ7MrV2rR2y8PhBteQ0Djmefnn6sKnldFD/vUdXaGcaNPmTlfTURSeGSsk7i2O/+MWemac5xU1Tqxbv9yhvCs8NBUEcOL7HpqYgyQym6NhfCJ8btfuKx/XBh2NHnzxMOy10Yarn5kyiXDUXeh37gAwech6nkaxC8n/LFYWoYSaDlSAuWA3MXnoomWUgE1UVWDgdh4uqVP++NSQKQU= jenkins@ubuntu\n"
        }
      ]
    }
  },
  "location": "koreacentral",
  "maxAgentPools": 100,
  "name": "gradle-canv",
  "networkProfile": {
    "dnsServiceIp": "10.0.0.10",
    "dockerBridgeCidr": "172.17.0.1/16",
    "ipFamilies": [
      "IPv4"
    ],
    "loadBalancerProfile": {
      "allocatedOutboundPorts": null,
      "effectiveOutboundIPs": [
        {
          "id": "/subscriptions/ce26c328-ebeb-4568-b91c-7d100e525c92/resourceGroups/MC_gradle-demo_gradle-canv_koreacentral/providers/Microsoft.Network/publicIPAddresses/3ae5a339-c76c-4eba-8d64-227c08272f7f",
          "resourceGroup": "MC_gradle-demo_gradle-canv_koreacentral"
        }
      ],
      "enableMultipleStandardLoadBalancers": null,
      "idleTimeoutInMinutes": null,
      "managedOutboundIPs": {
        "count": 1,
        "countIpv6": null
      },
      "outboundIPs": null,
      "outboundIpPrefixes": null
    },
    "loadBalancerSku": "Standard",
    "natGatewayProfile": null,
    "networkMode": null,
    "networkPlugin": "kubenet",
    "networkPolicy": null,
    "outboundType": "loadBalancer",
    "podCidr": "10.244.0.0/16",
    "podCidrs": [
      "10.244.0.0/16"
    ],
    "serviceCidr": "10.0.0.0/16",
    "serviceCidrs": [
      "10.0.0.0/16"
    ]
  },
  "nodeResourceGroup": "MC_gradle-demo_gradle-canv_koreacentral",
  "oidcIssuerProfile": {
    "enabled": false,
    "issuerUrl": null
  },
  "podIdentityProfile": null,
  "powerState": {
    "code": "Running"
  },
  "privateFqdn": null,
  "privateLinkResources": null,
  "provisioningState": "Succeeded",
  "publicNetworkAccess": null,
  "resourceGroup": "gradle-demo",
  "securityProfile": {
    "azureKeyVaultKms": null,
    "defender": null
  },
  "servicePrincipalProfile": {
    "clientId": "3a04c607-d9e6-41e2-a9dd-3a559a556d0e",
    "secret": null
  },
  "sku": {
    "name": "Basic",
    "tier": "Free"
  },
  "storageProfile": {
    "blobCsiDriver": null,
    "diskCsiDriver": {
      "enabled": true
    },
    "fileCsiDriver": {
      "enabled": true
    },
    "snapshotController": {
      "enabled": true
    }
  },
  "systemData": null,
  "tags": null,
  "type": "Microsoft.ContainerService/ManagedClusters",
  "windowsProfile": null,
  "workloadAutoScalerProfile": {
    "keda": null
  }
}
*/

5) Connect to the AKS cluster:
az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER

6) Grant ACR access to AKS:
kubectl create clusterrolebinding acr-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default

/* Creates a cluster role binding in a Kubernetes cluster that grants cluster-admin privileges to the default service account in the kube-system namespace.

In the context of an Azure Kubernetes Service (AKS) cluster integrated with an Azure Container Registry (ACR), this cluster role binding is necessary to allow the AKS cluster to access and pull images from ACR. The AKS cluster needs to have the proper permissions to perform this action, and the cluster role binding provides those permissions by granting the default service account in the kube-system namespace the highest level of privilege, cluster-admin.

Without the cluster role binding, the AKS cluster would not be able to access ACR and the deployment of images from ACR to the AKS cluster would fail. */

kubectl patch deploy --namespace kube-system tiller-deploy -p '{"spec":{"template":{"spec":{"serviceAccount":"default"}}}}'


7) Verify the integration:
kubectl get pods

Note: Replace <acrName>, <rgName>, <aksClusterName>, <appId>, and <password> with your specific values
